<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Spreadsheet Table</title>
  <link href="tabulator.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"
    crossorigin="anonymous"></script>

  <style>
    body {
      font-family: sans-serif;
      margin: 0px;
    }

    .search-container {
      margin-bottom: 20px;
    }

    .badge,
    .badge-skills {
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 0.7rem;
      display: inline-block;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .badge {
      background-color: #aaaaff;
    }

    .badge:hover {
      background-color: #9999ee;
    }

    .badge-skills {
      background-color: #ffd8b0;
    }

    .badge-skills:hover {
      background-color: #6873ec;
    }

    .badge-size-small {
      background-color: #b6fcb6;
      color: #222;
    }

    .badge-size-small:hover {
      background-color: #a5eba5;
    }

    .badge-size-medium {
      background-color: #4ec04e;
      color: #fff;
    }

    .badge-size-medium:hover {
      background-color: #3da93d;
    }

    .badge-size-large {
      background-color: #006400;
      color: #fff;
    }

    .badge-size-large:hover {
      background-color: #004d00;
    }

    #searchInput {
      width: 100%;
      padding: 3px 6px;
      font-size: 1rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      box-sizing: border-box;
      font-family: sans-serif;
      transition: border-color 0.2s ease;
    }

    #searchInput:focus {
      outline: none;
      border-color: #4ec04e;
      box-shadow: 0 0 0 3px rgba(78, 192, 78, 0.1);
    }

    #searchInput::placeholder {
      color: #999;
    }

    .svg-inline--fa {
      height: 0.7rem;
      color: black;
      transition: color 0.2s ease;
    }

    .svg-inline--fa:hover {
      color: white;
    }

    .tabulator-cell.wrap-text {
      white-space: normal !important;
      word-wrap: break-word;
      word-break: break-word;
      overflow-wrap: break-word;
    }

    .tabulator-cell.wrap-text .badge,
    .tabulator-cell.wrap-text .badge-skills {
      display: inline-block;
      margin: 2px;
    }

    .tabulator-cell {
      font-size: 0.7rem;
    }

    .tabulator-cell a:hover {
      color: white !important;
      transition: color 0.2s ease;

    }
  </style>
</head>

<body>
  <div class="search-container">
    <input type="text" id="searchInput" placeholder="Search across all fields...">
  </div>
  <div id="table"></div>

  <script type="text/javascript" src="tabulator.min.js"></script>
  <script>
    function addToSearch(value) {
      const input = document.getElementById("searchInput");
      const words = input.value.trim().split(/\s+/).filter(Boolean);
      const index = words.indexOf(value);
      if (index !== -1) words.splice(index, 1);
      else words.push(value);
      input.value = words.join(" ");
      input.dispatchEvent(new Event('input', { bubbles: true }));
    }

    function formatArrayOrStringColumn(value, cssClass) {
      const items = Array.isArray(value) ? value.filter(Boolean) :
        (value || "").split(",").map(item => item.trim()).filter(Boolean);
      return items.map(item =>
        `<span class="${cssClass}" onclick="addToSearch('${item.replace(/'/g, "\\'")}')">${item}</span>`
      ).join(" ");
    }

    function formatLinkColumn(cell, icon = "fa-external-link-alt", urlPrefix = "") {
      const value = cell.getValue();
      if (!value) return "";
      const url = urlPrefix ? `${urlPrefix}${value}` : value;
      return `<a href="${url}" target="_blank" rel="noopener noreferrer" title="${url}"><i class="fas ${icon}"></i></a>`;
    }

    const formatTagsColumn = (cell) => formatArrayOrStringColumn(cell.getValue(), "badge");
    const formatSkillsColumn = (cell) => formatArrayOrStringColumn(cell.getValue(), "badge-skills");
    const formatSizeColumn = (cell) => {
      const value = (cell.getValue() || "").trim().toLowerCase();
      return value ? `<span class="badge badge-size-${value}" onclick="addToSearch('${value}')">${value}</span>` : "";
    };
    const formatSlugLinkColumn = (cell) => formatLinkColumn(cell, "fa-external-link-alt", "https://thousandbrainsproject.readme.io/docs/");
    const formatEditLinkColumn = (cell) => formatLinkColumn(cell, "fa-pencil-alt", "https://github.com/thousandbrainsproject/tbp.monty/edit/main/");
    const formatTitleWithLinksColumn = (cell) => {
      const rowData = cell.getRow().getData();
      const title = cell.getValue() || "";
      const slug = rowData.slug || "";
      const path = rowData.path || "";

      let result = title;

      // Make title a link to docs if slug exists
      if (slug) {
        const docsUrl = `https://thousandbrainsproject.readme.io/docs/${slug}`;
        result = `<a href="${docsUrl}" target="_blank" rel="noopener noreferrer" style="text-decoration: none; color: inherit;">${title}</a>`;
      }

      // Add edit icon on the right if path exists
      if (path) {
        const editUrl = `https://github.com/thousandbrainsproject/tbp.monty/edit/main/${path}`;
        result = ` <a href="${editUrl}" style="margin-right:5px;" target="_blank" rel="noopener noreferrer"  title="Edit on GitHub"><i class="fas fa-pencil-alt"></i></a>` + result;
      }

      return '<div style="margin-right: 10px;">' + result + '</div>';
    };
    const formatStatusColumn = (cell) => {
      const rowData = cell.getRow().getData();
      const status = cell.getValue() || "";
      const owner = rowData.owner || "";

      let result = status;

      // Add GitHub avatars if owner exists
      if (owner) {
        const usernames = Array.isArray(owner) ? owner : owner.split(",").map(u => u.trim()).filter(Boolean);
        const avatars = usernames.map(username =>
          `<img src="https://github.com/${encodeURIComponent(username)}.png" width="24" height="24" style="vertical-align:middle;border-radius:2px;margin-left:5px;" alt="${username}"/>`
        ).join(" ");

        // Don't show "in-progress" text if avatars are present, as it's obvious from the avatars
        if (status.toLowerCase() === "in-progress") {
          result = avatars;
        } else {
          result = status + avatars;
        }
      }

      return result;
    };

    // Parse URL parameters to determine which columns to show
    function getColumnsToShow() {
      const urlParams = new URLSearchParams(window.location.search);
      const columnsParam = urlParams.get('columns');

      if (columnsParam) {
        return columnsParam.split(',').map(col => col.trim().toLowerCase());
      }

      // Default: show all columns
      return null;
    }

    // Define all available columns
    const allColumns = [
      { title: "Title", field: "title", formatter: formatTitleWithLinksColumn },
      { title: "Estimated Scope", field: "estimated-scope", formatter: formatSizeColumn },
      { title: "RFC", field: "rfc" },
      { title: "Status", field: "status", formatter: formatStatusColumn },
      { title: "Tags", field: "tags", formatter: formatTagsColumn, widthGrow: 2, cssClass: "wrap-text" },
      { title: "Skills", field: "skills", formatter: formatSkillsColumn, widthGrow: 2, cssClass: "wrap-text" }
    ];

    // Filter columns based on URL parameter
    const columnsToShow = getColumnsToShow();
    const displayColumns = columnsToShow ?
      allColumns.filter(col => columnsToShow.includes(col.field.toLowerCase()) || columnsToShow.includes(col.title.toLowerCase())) :
      allColumns;

    fetch('data.json')
      .then(res => res.json())
      .then(data => {
        const table = new Tabulator("#table", {
          data: data,
          layout: 'fitDataStretch',
          initialSort: [{ column: "title", dir: "asc" }],
          columns: displayColumns,
          groupBy: "path2"
        });

        document.getElementById("searchInput").addEventListener("input", e => {
          const searchTerm = e.target.value.toLowerCase().trim();
          if (!searchTerm) {
            table.clearFilter();
          } else {
            table.setFilter(data => {
              const allText = [data.title, data.tags, data.skills, data.status, data.owner, data["estimated-scope"], data.link, data.path2]
                .filter(Boolean).join(" ").toLowerCase();
              return searchTerm.split(/\s+/).every(word => allText.includes(word));
            });
          }
        });
      })
      .catch(console.error);
  </script>
</body>

</html>